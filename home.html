import tkinter as tk
from tkinter import ttk, messagebox
from PIL import Image, ImageTk, ImageSequence
import requests

BASE_URL = "http://127.0.0.1:5000"  # Backend URL

# ------------------- Backend Helpers -------------------

def load_all_media():
    try:
        r = requests.get(f"{BASE_URL}/media")
        return r.json()
    except:
        messagebox.showerror("Error", "Cannot connect to backend.")
        return {}

def load_category_media(category):
    try:
        r = requests.get(f"{BASE_URL}/media/category/{category}")
        return r.json()
    except:
        messagebox.showerror("Error", "Cannot connect to backend.")
        return {}

def search_media(name):
    try:
        r = requests.get(f"{BASE_URL}/media/search/{name}")
        return r.json()
    except:
        messagebox.showerror("Error", "Cannot connect to backend.")
        return {}

def create_media(name, author, date, category):
    data = {
        "name": name,
        "author": author,
        "publication_date": date,
        "category": category
    }
    try:
        r = requests.post(f"{BASE_URL}/media/create", json=data)
        return r.json()
    except:
        messagebox.showerror("Error", "Cannot connect to backend.")
        return {}

def delete_media(item_id):
    try:
        r = requests.delete(f"{BASE_URL}/media/delete/{item_id}")
        return r.json()
    except:
        messagebox.showerror("Error", "Cannot connect to backend.")
        return {}

# ------------------- Animated GIF Class -------------------

class AnimatedGIFLabel(tk.Label):
    """Label that can display an animated GIF"""
    def __init__(self, master, path, *args, **kwargs):
        super().__init__(master, *args, **kwargs)
        self.sequence = []
        self.image_index = 0
        # Try to load GIF frames; if file missing or invalid, degrade gracefully
        try:
            if path and os.path.exists(path):
                frames = [frame.copy() for frame in ImageSequence.Iterator(Image.open(path))]
                # Convert frames to PhotoImage objects
                self.sequence = [ImageTk.PhotoImage(img) for img in frames]
        except Exception:
            # If anything goes wrong, leave sequence empty (no banner)
            self.sequence = []

        if self.sequence:
            try:
                self.config(image=self.sequence[0])
                self.after(100, self.animate)
            except Exception:
                # ignore any TK image errors
                pass

    def animate(self):
        if not self.sequence:
            return
        self.image_index = (self.image_index + 1) % len(self.sequence)
        try:
            self.config(image=self.sequence[self.image_index])
        except Exception:
            return
        self.after(100, self.animate)

# ------------------- Library GUI -------------------

class LibraryGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("ðŸ“š Online Library")
        self.root.geometry("750x550")
        self.root.configure(bg="#e6f4ea")  # light green background

        # ---------- Animated banner ----------
        self.banner = AnimatedGIFLabel(root, "library.gif", bg="#e6f4ea")
        self.banner.pack(pady=5)

        # ---------- Title ----------
        title = tk.Label(root, text="Online Library", font=("Helvetica Neue", 22, "bold"), bg="#e6f4ea", fg="#2e5d31")
        title.pack(pady=10)

        # ---------- Buttons & Search ----------
        btn_frame = tk.Frame(root, bg="#e6f4ea")
        btn_frame.pack(pady=5)

        self.style_buttons(btn_frame)

        # Category Dropdown
        self.category_var = tk.StringVar()
        category_menu = ttk.Combobox(btn_frame, textvariable=self.category_var, values=["Book", "Film", "Magazine"], width=15, font=("Helvetica", 11))
        category_menu.grid(row=0, column=1, padx=5)

        tk.Button(btn_frame, text="Filter", width=10, command=self.filter_category, bg="#ffa64d", fg="#333").grid(row=0, column=2)

        # Search box
        self.search_var = tk.StringVar()
        tk.Entry(btn_frame, textvariable=self.search_var, width=20, font=("Helvetica", 11)).grid(row=0, column=3, padx=5)
        tk.Button(btn_frame, text="Search", command=self.search_item, bg="#7fd88f", fg="#333").grid(row=0, column=4)

        # ---------- Media List ----------
        self.media_list = tk.Listbox(root, width=75, height=15, font=("Helvetica", 12), bg="#dff2d8", fg="#2e5d31", selectbackground="#ffa64d")
        self.media_list.pack(pady=10)
        self.media_list.bind("<<ListboxSelect>>", self.show_details)

        # ---------- Details area ----------
        self.details_label = tk.Label(root, text="Select a media to see details", font=("Helvetica Neue", 12), bg="#e6f4ea", fg="#2e5d31")
        self.details_label.pack(pady=5)

        # ---------- Add / Delete ----------
        bottom_frame = tk.Frame(root, bg="#e6f4ea")
        bottom_frame.pack(pady=10)

        tk.Button(bottom_frame, text="Add Book", command=self.add_media_window, bg="#7fd88f", fg="#333").grid(row=0, column=0, padx=10)
        tk.Button(bottom_frame, text="Delete Book", command=self.remove_selected, bg="#ffa64d", fg="#333").grid(row=0, column=1, padx=10)

        self.media_data = {}
        # Load items on startup
        try:
            self.show_all()
        except Exception:
            # If backend is not available, ignore and allow user to try Refresh
            pass

    # ---------- Button Styling ----------
    def style_buttons(self, frame):
        for widget in frame.winfo_children():
            if isinstance(widget, tk.Button):
                widget.config(bg="#7fd88f", fg="#333", font=("Helvetica", 11), relief="flat", activebackground="#a6e6b8", activeforeground="#000")

    # ------------------- Functions -------------------

    def show_all(self):
        self.media_data = load_all_media()
        self.update_list()

    def filter_category(self):
        category = self.category_var.get()
        if not category:
            messagebox.showwarning("Warning", "Select a category")
            return
        self.media_data = load_category_media(category)
        self.update_list()

    def search_item(self):
        name = self.search_var.get()
        if not name:
            messagebox.showwarning("Warning", "Enter a name to search")
            return
        result = search_media(name)
        if "error" in result:
            messagebox.showinfo("Not Found", "Media not found")
        else:
            self.media_data = result
            self.update_list()

    def update_list(self):
        self.media_list.delete(0, tk.END)
        for item_id, info in self.media_data.items():
            self.media_list.insert(tk.END, f"{item_id}: {info['name']}")

    def show_details(self, event):
        selection = self.media_list.curselection()
        if not selection:
            return
        index = selection[0]
        item_id = list(self.media_data.keys())[index]
        item = self.media_data[item_id]

        details = (
            f"ID: {item_id}\n"
            f"Name: {item['name']}\n"
            f"Author: {item['author']}\n"
            f"Publication Date: {item['publication_date']}\n"
            f"Category: {item['category']}"
        )
        self.details_label.config(text=details)

    def add_media_window(self):
        win = tk.Toplevel(self.root)
        win.title("Add Book")
        win.geometry("320x240")
        win.configure(bg="#e6f4ea")

        tk.Label(win, text="Book Name", bg="#e6f4ea").pack(pady=2)
        name = tk.Entry(win, font=("Helvetica", 11))
        name.pack()

        tk.Label(win, text="Author", bg="#e6f4ea").pack(pady=2)
        author = tk.Entry(win, font=("Helvetica", 11))
        author.pack()

        tk.Label(win, text="Publication Date", bg="#e6f4ea").pack(pady=2)
        date = tk.Entry(win, font=("Helvetica", 11))
        date.pack()

        forced_category = "Book"

        def submit():
            if not name.get().strip() or not author.get().strip():
                messagebox.showwarning("Warning", "Please provide both Book Name and Author")
                return
            create_media(name.get(), author.get(), date.get(), forced_category)
            win.destroy()
            self.show_all()

        tk.Button(win, text="Add Book", command=submit, bg="#7fd88f", font=("Helvetica", 11)).pack(pady=10)

    def remove_selected(self):
        selection = self.media_list.curselection()
        if not selection:
            messagebox.showwarning("Warning", "No item selected")
            return
        index = selection[0]
        item_id = list(self.media_data.keys())[index]
        delete_media(item_id)
        self.show_all()


# ------------------- Run GUI -------------------

root = tk.Tk()
app = LibraryGUI(root)
root.mainloop()

